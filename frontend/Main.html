<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Main | SCRaSMS</title>

  <link rel="stylesheet" href="SideBar/studentSideBar.css" />
  <link rel="stylesheet" href="Dashboard/studentDashboard.css" />
  <link rel="stylesheet" href="StudentProfile/studentProfile.css" />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar-container {
      width: 0;
      flex-shrink: 0;
    }
    .collapsed {
      width: 60px !important;
    }
    #content {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f8f8;
      margin-left: 290px; 
      margin-right: 30px;
    }
    @media (max-width: 900px) {
      #content {
        margin-left: 0;
      }
    }
    #burger {
      display: none;
      position: fixed;
      right: 16px;
      bottom: 18px;
      z-index: 120;
      background: #0b6ef6;
      color: #fff;
      border: 0;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      display: inline-flex;
      box-shadow: 0 6px 20px rgba(11,110,246,0.18);
    }
    @media (max-width:900px){
      #burger{display:inline-flex}
    }
  </style>
</head>

<body>

  <button id="burger" aria-label="Open menu">â˜°</button>

  <div id="sidebar-container"></div>
  <div id="content">
      <h2>Loading...</h2>
  </div>

  <script>
    fetch("SideBar/studentSideBar.html")
      .then(res => res.text())
      .then(html => {
        console.debug('Main.html: fetched sidebar fragment', html);
        // Inject sidebar HTML into container
        const container = document.getElementById("sidebar-container");
        container.innerHTML = html;

        // Grab the sidebar element now in DOM
        const sidebar = container.querySelector('.sidebar');
        if (!sidebar) throw new Error('Sidebar element not found');

        // Sidebar toggle button logic inside sidebar
        const toggle = sidebar.querySelector('#menuToggle');
        toggle.addEventListener('click', () => {
          sidebar.classList.toggle('open');
          // Hide burger button when sidebar is open
          if(window.innerWidth <= 900){
            burger.style.display = sidebar.classList.contains('open') ? 'none' : '';
          }
        });

        // Populate user info after sidebar inserted
        try {
          const stored = JSON.parse(localStorage.getItem('user'));
          if (stored) {
            sidebar.querySelector('.meta .name').textContent = stored.email || 'No Email';
            sidebar.querySelector('.meta .id').textContent = stored.id || 'No ID';
            sidebar.querySelector('.avatar').textContent = stored.role ? stored.role[0].toUpperCase() : 'S';
          }
        } catch (err) {
          console.warn('Failed to populate sidebar profile:', err);
        }

        // Logout button
        const logoutBtn = sidebar.querySelector('.logout');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('user');
            window.location.href = '/frontend/LogInSignUp/login.html';
          });
        }

        // Close sidebar clicking outside on small screens
        document.addEventListener('click', (e) => {
          if(window.innerWidth > 900) return;
          if (!sidebar.contains(e.target) && !toggle.contains(e.target) && !burger.contains(e.target)) {
            sidebar.classList.remove('open');
            burger.style.display = '';
          }
        });
      })
      .catch(error => console.error("Error loading sidebar:", error));

    // External burger button toggles sidebar on small screens
    const burger = document.getElementById('burger');
    burger.addEventListener('click', () => {
      const sidebar = document.querySelector('#sidebar-container .sidebar');
      if(!sidebar) return;
      const opened = sidebar.classList.toggle('open');
      burger.style.display = opened ? 'none' : '';
    });

    // Navigation active item management
    (function(){
      function findSidebar(){
        return document.querySelector('#sidebar-container .sidebar') || document.querySelector('.sidebar');
      }
      function clearActiveNav(){
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      }
      function setActiveNavByElem(el){
        if(!el) return;
        const item = el.closest('.nav-item');
        if(!item) return;
        clearActiveNav();
        item.classList.add('active');
      }
      function setActiveNavByPath(path){
        if(!path) return;
        const norm = path.replace(/^\.\//, '').replace(/^\//, '');
        const items = document.querySelectorAll('.nav-item');
        items.forEach(i => {
          const target = i.getAttribute('data-load') || i.getAttribute('href') || '';
          const tnorm = (target || '').replace(/^\.\//, '').replace(/^\//, '');
          if(tnorm === norm){
            clearActiveNav();
            i.classList.add('active');
          }
        });
      }
      window.__setActiveNavByElem = setActiveNavByElem;
      window.__setActiveNavByPath = setActiveNavByPath;
      window.__clearActiveNav = clearActiveNav;
    })();

    // Load page content helper
    function loadPage(page) {
      fetch(page)
          .then(res => {
          if (!res.ok) throw new Error(`Failed to load page: ${res.status} ${res.statusText} for ${page}`);
          return res.text();
        })
          .then(htmlText => {
            console.debug('Main.html: fetched page', page);
            console.debug(htmlText);
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlText, 'text/html');
          // Resolve asset URLs inside the fetched fragment so relative paths work
          const baseUrl = new URL(page, location.href).href;

          // Normalize stylesheet hrefs and append them to document.head
          const fragStyles = doc.querySelectorAll('link[rel="stylesheet"]');
          fragStyles.forEach(link => {
            const href = link.getAttribute('href');
            if (!href) return;
            // If href is relative, resolve against page URL
            const resolved = /^(https?:|\/)/.test(href) ? href : new URL(href, baseUrl).href;
            const newLink = document.createElement('link');
            newLink.rel = 'stylesheet';
            newLink.href = resolved;
            document.head.appendChild(newLink);
          });

          // Resolve script src attributes so they load from correct paths
          const scripts = doc.querySelectorAll('script');
          scripts.forEach(s => {
            const src = s.getAttribute('src');
            if (src && !/^(https?:|\/)/.test(src)) {
              s.src = new URL(src, baseUrl).href;
            }
          });

          // Extract the preferred wrapper (keeps inner padding/structure)
          const preferred = doc.querySelector('main') || doc.querySelector('#content') || doc.querySelector('.main') || doc.body;
          const fragment = preferred ? preferred.innerHTML : htmlText;
          const target = document.getElementById('content');
          target.innerHTML = fragment;

          try {
            if(window.__setActiveNavByPath) window.__setActiveNavByPath(page);
          } catch(e) {}

          // Execute scripts (external scripts will load using resolved src)
          scripts.forEach(oldScript => {
            const s = document.createElement('script');
            if(oldScript.src) s.src = oldScript.src;
            else s.textContent = oldScript.textContent;
            document.body.appendChild(s);
            document.body.removeChild(s);
          });
        })
        .catch(error => {
          console.error('Page loading failed:', error);
          document.getElementById('content').innerHTML =
            `<h2 style="color: red;">Error Loading Page</h2>
             <p>Could not load the requested page: <strong>${page}</strong></p>
             <p>Check your file paths.</p>`;
        });
    }

    // // Initial load
    // loadPage("Dashboard/studentDashboard.html");

    const stored_data = JSON.parse(localStorage.getItem('user'));
    if (stored_data && stored_data.role === 'student') {
      loadPage("Dashboard/studentDashboard.html");
    } else if (stored_data && stored_data.role === 'admin') {
      loadPage("AdminDashboard/adminDashboard.html");
    } else {
      loadPage("LogInSignUp/login.html");
    }

    // Delegate clicks on nav links with data-load attr
    document.addEventListener("click", function (e) {
      if (e.target.matches("[data-load]") || e.target.closest("[data-load]")) {
        e.preventDefault();
        const target = e.target.getAttribute("data-load") ? e.target : e.target.closest("[data-load]");
        const path = target.getAttribute("data-load");
        if (window.__setActiveNavByElem) window.__setActiveNavByElem(target);
        loadPage(path);
      }
    });
  </script>

</body>
</html>
